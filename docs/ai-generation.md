# yumicuit AI生成設計

## 概要

yumicuitのAI生成は「強引作文」がコンセプト。
断片的なキーワードから、AIが無理やりストーリーを作る。

## LLM方針

### ローカルとオンラインの両対応

ユーザーは無料のオンラインLLM（ChatGPT無料版、Gemini、Claude等）に慣れている。
その性能向上の恩恵を受けられるようにする。

```
ユーザー選択
  ├─ ローカルLLM（WebLLM / wllama）
  │     └─ オフライン動作、プライバシー最強
  │
  └─ オンラインLLM（ユーザーの既存アカウント）
        └─ 性能向上の恩恵、無料枠活用
```

### yumicuitの役割

**プロンプトの代筆 + API呼び出しの代行**

1. ユーザーの断片（日本語）を受け取る
2. 英語の最適なプロンプトを構築
3. ユーザーが選んだLLMに送信
4. 結果を整形して返す

ユーザーは難しいプロンプトを書く必要がない。
yumicuitが「夢の短編を生成するプロンプト」を代筆する。

### 対応LLM

| LLM | 方式 | 備考 |
|-----|------|------|
| ローカル（WebLLM） | ブラウザ内推論 | オフライン、プライバシー◎ |
| ローカル（wllama） | WASM/CPU | WebGPU非対応環境 |
| ChatGPT（無料版） | API or 手動コピペ | 無料枠あり |
| Gemini | API | 無料枠あり |
| Claude | API | 無料枠あり |
| Groq | API | 高速、無料枠あり |

### 実装パターン

#### パターンA: API連携（自動）

ユーザーがAPIキーを設定すれば自動で呼び出し。

```
断片入力 → yumicuitがプロンプト構築 → API呼び出し → 結果表示
```

#### パターンB: コピペ連携（手動）

APIキーなしでも使える。

```
断片入力 → yumicuitがプロンプト生成 → ユーザーがコピー
→ ChatGPT等に貼り付け → 結果をyumicuitに貼り付け
```

手動だが、ユーザーの既存アカウント（無料枠）をそのまま使える。

### ローカルLLM技術選択

```
WebGPU対応？
  ├─ YES → WebLLM (MLC)
  └─ NO  → wllama (WASM/CPU)
```

| エンジン | 条件 | 速度 |
|----------|------|------|
| WebLLM | WebGPU対応 | 高速（GPU推論） |
| wllama | フォールバック | 低速（CPU推論） |

---

## モデル選択

### 推奨モデル（3B-4Bクラス）

| モデル | パラメータ | 量子化 | サイズ目安 |
|--------|------------|--------|------------|
| Phi-3.5 mini | 3.8B | Q4_K_M | 2.2 GB |
| Llama 3.2 | 3B | Q4_K_M | 1.8 GB |
| Gemma 2 | 2B | Q4_K_M | 1.5 GB |

### 選択基準

- スマホで動く（メモリ4GB以下で推論可能）
- 日本語対応
- 創作能力がある程度ある

### ダウンロード戦略

1. 初回起動時に最小モデル（2B）を提案
2. 端末性能を検出
3. 余裕があれば高品質モデルを後からダウンロード提案
4. 分割ダウンロードで中断・再開可能

---

## 生成フロー

```
断片入力
  ↓
プロンプト構築
  ↓
LLM推論（3回）
  ↓
3案の短編を返却
  ↓
ユーザーが選択 or パラメータ変更して再生成
  ↓
確定
  ↓
夢の種（キーワード + 核の一文）を生成
```

---

## プロンプト設計

### 短編生成プロンプト

```
あなたは夢を短い物語にする作家です。
以下のキーワードは、誰かが見た楽しい夢の断片です。
これらの断片から、150〜300字の短い夢の物語を作ってください。

【ルール】
- 一人称視点で書く
- 夢らしい不思議さを残す
- 楽しい・心地よい雰囲気を維持する
- すべてのキーワードを使う必要はない
- 論理的な整合性より、感覚的なつながりを重視する

【キーワード】
{tokens}

【連想の方向】
{focus}を中心に展開してください。

【創造性レベル】
{force} (0=キーワードに忠実, 1=自由に飛躍)

【物語】
```

### パラメータ

#### force（強引さ）

| 値 | 意味 | 生成傾向 |
|----|------|----------|
| 0.0-0.3 | 保守的 | キーワードに忠実、シンプル |
| 0.4-0.6 | バランス | 適度に創作を加える |
| 0.7-1.0 | 創造的 | キーワードから大きく飛躍 |

- LLMのtemperatureにマッピング
- 0.3 → temperature 0.3
- 1.0 → temperature 1.0

#### focus（連想方向）

| 値 | プロンプト追加 |
|----|----------------|
| place | 「場所の描写を詳しく」 |
| person | 「登場人物の関係性を中心に」 |
| emotion | 「感情の流れを大切に」 |
| color | 「色彩を印象的に」 |
| sound | 「音や声を効果的に」 |

---

## 夢の種（Seeds）生成

確定後、就寝前プライミング用のデータを生成。

### キーワード抽出プロンプト

```
以下の夢の物語から、最も印象的なキーワードを5〜7個抽出してください。
名詞・動詞・形容詞を優先してください。

【物語】
{confirmedStory}

【キーワード】（カンマ区切り）
```

### 核の一文生成プロンプト

```
以下の夢の物語を、1文（30字以内）で表現してください。
詩的で、印象に残る表現にしてください。

【物語】
{confirmedStory}

【一文】
```

### 出力例

```
キーワード: 港, 緑の鳥, 雷, 笑った, 追いかけっこ
核の一文: 雷鳴の海で、緑の鳥を追いかけて笑った。
```

---

## 推論設定

### WebLLM設定

```javascript
const config = {
  model: "Phi-3.5-mini-instruct-q4f16_1-MLC",
  temperature: force,  // 0.0-1.0
  max_tokens: 500,
  top_p: 0.9,
  repetition_penalty: 1.1,
};
```

### ストリーミング

- 生成中はリアルタイムで文字を表示
- UIブロックを防ぐ
- キャンセル可能に

```javascript
for await (const chunk of engine.chat.completions.create({
  ...config,
  stream: true,
})) {
  onChunk(chunk.choices[0]?.delta?.content || "");
}
```

---

## 3案同時生成

### 方針

1案ずつ順番に生成（並列は端末負荷が高い）

```javascript
async function generate3Stories(tokens, focus, force) {
  const stories = [];

  // 3つの異なるパラメータで生成
  const params = [
    { force: force - 0.1, focus },
    { force, focus },
    { force: force + 0.1, focus },
  ];

  for (const p of params) {
    const story = await generateStory(tokens, p);
    stories.push(story);
  }

  return stories;
}
```

### UI表示

- 1案目が完成したら即表示
- 2案目、3案目は順次追加
- 「生成中...」の表示でフィードバック

---

## エラーハンドリング

### モデル未ダウンロード

```
「AI生成にはモデルのダウンロードが必要です」
[ダウンロード開始] [後で]
```

### メモリ不足

```
「端末のメモリが不足しています。
他のアプリを閉じるか、小さいモデルを選択してください」
[小さいモデルに変更] [キャンセル]
```

### 生成失敗

```
「生成に失敗しました。再試行しますか？」
[再試行] [キャンセル]
```

---

## オフライン対応

- モデルはIndexedDB/CacheStorageにキャッシュ
- 一度ダウンロードすれば以降はオフラインで動作
- ネットワーク状態を検出して適切なUIを表示

```javascript
const isOnline = navigator.onLine;
const hasModel = await checkModelCache();

if (!hasModel && !isOnline) {
  showMessage("オフラインではAI生成を使用できません。\nネットワークに接続してモデルをダウンロードしてください。");
}
```

---

## 将来の拡張

### Dream Camera（画像生成）

断片 + 参照画像 → 夢の景色を生成

```
ユーザーが参照画像を選択
  ├─ ローカル写真
  └─ ネット画像検索
      ↓
yumicuitがプロンプト構築（英語）
  「このビルとこの空を組み合わせて...」
      ↓
画像生成LLMに送信
  ├─ Stable Diffusion (ローカル)
  ├─ DALL-E (API)
  ├─ Midjourney (手動コピペ)
  └─ その他
      ↓
夢の景色を生成
```

yumicuitは「参照画像の添付」と「英語プロンプトの代筆」を代行。
ユーザーは自分が使い慣れたツールで画像生成できる。

### モデルの更新

- 新しいモデルが出たらアプリ内で通知
- ユーザーが選択してダウンロード
- 古いモデルは削除可能

### ファインチューニング（遠い将来）

- ユーザーの確定履歴から学習
- より個人に合った生成に
- ただしプライバシー最優先（ローカルのみ）
